/* Begin file: namespace.js */
if(typeof console=='undefined'){var console=(function(){if(console!=undefined){return console;}
var noop=function(){};var names=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];var consoleT={};for(var i=0;i<names.length;++i){consoleT[names[i]]=noop;}
return consoleT;}());}
var namespace=(function(){try{if(namespace!=undefined){return namespace;}}
catch(e){}
function Namespace(parent,name){if(name){name=name.replace(/-/g,'_');}
this._isDefined=false;this._referenced=[];this._parent=parent;if(this._parent){this._parent[name]=this;this._path=this._parent._path;if(this._path!==''){this._path+='.';}
this._path+=name;}else{this._path='';}}
var namespaceT=new Namespace(null);function extendObject(dest,args){if(dest===undefined){dest={};}
for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var prop in source){if(source.hasOwnProperty(prop)){dest[prop]=source[prop];}}}
return dest;}
function copyArray(arg){return Array.prototype.slice.call(arg,0);}
Function.prototype.methods=function(obj){extendObject(this.prototype,obj);};Function.methods({fnMethod:function(obj){var _fn=this;return function(){return _fn.apply(obj,arguments);};},fnArgs:function(){var _fn=this;var _args=copyArray(arguments);return function(){var args=copyArray(arguments).concat(_args);var self=this;return _fn.apply(self,args);};}});Namespace.methods({define:function(callback){this._isDefined=true;console.info("Namespace '"+this._path+"' defined.");if(callback){Namespace.defining=this;callback(this);Namespace.defining=undefined;}
return this;},defineOnce:function(callback){if(this._isDefined){console.warn("Namespace '"+this._path+"' redefinition.");return this;}
return this.define(callback);},extend:function(){var args=[this].concat(copyArray(arguments));return extendObject.apply(undefined,args);},nameOf:function(symbol){symbol=symbol.replace(/-/g,'_');return'namespace.'+this._path+'.'+symbol;}});extendObject(namespaceT,{lookup:function(path){var fCreated=false;path=path.replace(/-/g,'_');var parts=path.split('.');var cur=namespaceT;for(var i=0;i<parts.length;i++){var name=parts[i];if(cur[name]===undefined){cur=new Namespace(cur,name);fCreated=true;}
else{cur=cur[name];}}
if(Namespace.defining){Namespace.defining._referenced.push(cur);if(fCreated){console.warn("Forward reference from "+
Namespace.defining._path+" to "+
path+".");}}
return cur;}});namespaceT.lookup('util').extend({extendObject:extendObject,copyArray:copyArray}).defineOnce();return namespaceT;}());
/* Begin file: base.js */
namespace.lookup('org.startpad.base').defineOnce(function(ns){var util=namespace.util;function Enum(args){var j=0;for(var i=0;i<arguments.length;i++){if(typeof arguments[i]=="string"){this[arguments[i]]=j++;}
else{j=arguments[i];}}}
Enum.methods({getName:function(value){for(var prop in this){if(this.hasOwnProperty(prop)){if(this[prop]==value){return prop;}}}}});function StBuf(){this.rgst=[];this.append.apply(this,arguments);}
StBuf.methods({append:function(){for(var ist=0;ist<arguments.length;ist++){this.rgst.push(arguments[ist].toString());}
return this;},clear:function(){this.rgst=[];},toString:function(){return this.rgst.join("");}});function extendIfMissing(oDest,var_args){if(oDest==undefined){oDest={};}
for(var i=1;i<arguments.length;i++){var oSource=arguments[i];for(var prop in oSource){if(oSource.hasOwnProperty(prop)&&oDest[prop]==undefined){oDest[prop]=oSource[prop];}}}
return oDest;}
function extendDeep(dest){for(var i=1;i<arguments.length;i++){var src=arguments[i];for(var prop in src){if(src.hasOwnProperty(prop)){if(src[prop]instanceof Array){dest[prop]=[];ns.extendDeep(dest[prop],src[prop]);}
else if(src[prop]instanceof Object){dest[prop]={};ns.extendDeep(dest[prop],src[prop]);}
else{dest[prop]=src[prop];}}}}}
function randomInt(n){return Math.floor(Math.random()*n);}
function strip(s){return(s||"").replace(/^\s+|\s+$/g,"");}
function project(obj,asProps){var objT={};for(var i=0;i<asProps.length;i++){objT[asProps[i]]=obj[asProps[i]];}
return objT;}
function uniqueArray(a){if(!a){return;}
a.sort();for(var i=1;i<a.length;i++){if(a[i-1]==a[i]){a.splice(i,1);}}}
function map(a,fn){var aRes=[];for(var i=0;i<a.length;i++){aRes.push(fn(a[i]));}
return aRes;}
function filter(a,fn){var aRes=[];for(var i=0;i<a.length;i++){if(fn(a[i])){aRes.push(a[i]);}}
return aRes;}
function reduce(a,fn){if(a.length<2){return a[0];}
var res=a[0];for(var i=1;i<a.length-1;i++){res=fn(res,a[i]);}
return res;}
ns.extend({extendObject:util.extendObject,Enum:Enum,StBuf:StBuf,extendIfMissing:extendIfMissing,extendDeep:extendDeep,randomInt:randomInt,strip:strip,project:project,uniqueArray:uniqueArray,map:map,filter:filter,reduce:reduce});});
/* Begin file: random.js */
namespace.lookup("com.pageforest.random").defineOnce(function(ns){ns.upper='ABCDEFGHIJKLMNOPQRSTUVWXYZ';ns.lower='abcdefghijklmnopqrstuvwxyz';ns.digits='0123456789';ns.base64=ns.upper+ns.lower+ns.digits+'+/';ns.base64url=ns.upper+ns.lower+ns.digits+'-_';ns.hexdigits=ns.digits+'abcdef';ns.randomString=function(len,chars){if(typeof chars=='undefined'){chars=ns.base64url;}
var radix=chars.length;var result=[];for(var i=0;i<len;i++){result[i]=chars[0|Math.random()*radix];}
return result.join('');};});
/* Begin file: cookies.js */
namespace.lookup('org.startpad.cookies').define(function(ns){var base=namespace.lookup('org.startpad.base');function setCookie(name,value,days,path){var expires='';if(days){var date=new Date();date.setTime(date.getTime()+days*24*60*60*1000);expires='; expires='+date.toGMTString();}
path='; path='+(path||'/');document.cookie=encodeURIComponent(name)+'='+
encodeURIComponent(value)+expires+path;}
function getCookie(name){return ns.getCookies()[name];}
function getCookies(name){var st=document.cookie;var rgPairs=st.split(";");var obj={};for(var i=0;i<rgPairs.length;i++){rgPairs[i]=base.strip(rgPairs[i]);var rgC=rgPairs[i].split("=");var val=decodeURIComponent(rgC[1]);var rg=val.match('^"(.*)"$');if(rg){val=rg[1].replace('\\"','"');}
obj[decodeURIComponent(rgC[0])]=val;}
return obj;}
ns.extend({setCookie:setCookie,getCookie:getCookie,getCookies:getCookies});});
/* Begin file: format.js */
namespace.lookup('org.startpad.format').defineOnce(function(ns){var base=namespace.lookup('org.startpad.base');var comma=',';function fixedDigits(value,digits,fSign){var s="";var fNeg=(value<0);if(digits==undefined){digits=0;}
if(fNeg){value=-value;}
value=Math.floor(value);for(;digits>0;digits--){s=(value%10)+s;value=Math.floor(value/10);}
if(fSign||fNeg){s=(fNeg?"-":"+")+s;}
return s;}
function thousands(value,digits){var integerPart=Math.floor(value);var s=value.toString();var sLast="";while(s!=sLast){sLast=s;s=s.replace(/(\d+)(\d{3})/,"$1"+comma+"$2");}
var fractionString="";if(digits&&digits>0){var fraction=value-integerPart;fraction=Math.floor(fraction*Math.pow(10,digits));fractionString="."+fixedDigits(fraction,digits);}
return s+fractionString;}
function slugify(s){s=base.strip(s).toLowerCase();s=s.replace(/[^a-zA-Z0-9]/g,'-').replace(/[\-]+/g,'-').replace(/(^-+)|(-+$)/g,'');return s;}
function escapeHTML(s){s=s.toString();s=s.replace(/&/g,'&amp;');s=s.replace(/</g,'&lt;');s=s.replace(/>/g,'&gt;');s=s.replace(/\"/g,'&quot;');s=s.replace(/'/g,'&#39;');return s;}
function replaceString(string,pattern,replacement){var output="";if(replacement==undefined){replacement="";}
else{replacement=replacement.toString();}
var ich=0;var ichFind=string.indexOf(pattern,0);while(ichFind>=0){output+=string.substring(ich,ichFind)+replacement;ich=ichFind+pattern.length;ichFind=string.indexOf(pattern,ich);}
output+=string.substring(ich);return output;}
function replaceKeys(st,keys){for(var key in keys){if(keys.hasOwnProperty(key)){st=replaceString(st,"{"+key+"}",keys[key]);}}
st=st.replace(/\{[^\{\}]*\}/g,"");return st;}
ns.extend({fixedDigits:fixedDigits,thousands:thousands,slugify:slugify,escapeHTML:escapeHTML,replaceKeys:replaceKeys,replaceString:replaceString});});
/* Begin file: client.js */
namespace.lookup('com.pageforest.client').defineOnce(function(ns){var cookies=namespace.lookup('org.startpad.cookies');var base=namespace.lookup('org.startpad.base');var format=namespace.lookup('org.startpad.format');var pollInterval=1000;var discardMessage="You will lose your document changes if you continue.";var jQueryMessage="jQuery must be installed to use this library.";var signInMessage="You must sign in to save a document.";var unloadMessage="You will lose your changes if you leave "+"the document without saving.";var objectMessage="Document data is missing.";var titleMessage="Document is missing a title.";var blobMessage="Document is missing a blob property.";function Client(app){this.app=app;this.appHost=location.host;var dot=this.appHost.indexOf('.');this.appid=this.appHost.substr(0,dot);this.wwwHost='www'+this.appHost.substr(dot);this.state=Client.states.clean;this.username=undefined;this.fLogging=false;this.saveInterval=60;this.setCleanDoc(undefined,true);setInterval(this.poll.fnMethod(this),pollInterval);if(typeof $!='function'||$!=jQuery){this.errorReport('jQuery_required',jQueryMessage);return;}
$(window).bind('beforeunload',this.beforeUnload.fnMethod(this));}
Client.states=new base.Enum('clean','dirty','loading','saving');Client.methods({load:function(docid){if(this.isDirty()){if(!this.confirmDiscard()){return;}
this.changeState(Client.states.clean);}
this.stateSave=this.state;this.changeState(Client.states.loading);this.log("loading: "+docid);$.ajax({dataType:'json',url:this.getDocURL(docid),error:this.errorHandler.fnMethod(this),success:function(document,textStatus,xmlhttp){this.app.setData(document);this.setCleanDoc(docid);}.fnMethod(this)});},save:function(json,docid){if(this.username==undefined){this.errorReport('no_username',signInMessage);return;}
if(json==undefined){json=this.app.getData();if(typeof json!='object'){this.errorReport('missing_object',objectMessage);return;}
if(json.title==undefined){this.errorReport('missing_title',titleMessage);return;}
if(json.blob==undefined){this.errorReport('missing_blob',blobMessage);return;}}
if(docid==undefined){docid=this.docid;}
if(docid==undefined){docid=this.username+'-'+json.title+'-'+
base.randomInt(10000);docid=format.slugify(docid);}
this.stateSave=this.state;this.changeState(Client.states.saving);if(!json.readers){json.readers=['public'];}
var data=JSON.stringify(json);this.log('saving: '+docid,json);$.ajax({type:'PUT',url:'/docs/'+docid,data:data,error:this.errorHandler.fnMethod(this),success:function(data){this.setCleanDoc(docid);this.log('saved');if(this.app.onSaveSuccess){this.app.onSaveSuccess();}}.fnMethod(this)});},detach:function(){this.setCleanDoc();this.setDirty();},setCleanDoc:function(docid,preserveHash){this.docid=docid;this.changeState(Client.states.clean);this.lastJSON=JSON.stringify(this.app.getData());if(preserveHash){this.lastHash='';return;}
if(docid==undefined){docid='';}
location.hash=docid;this.lastHash=location.hash;location.href=location.href;},getDocURL:function(docid){if(docid==undefined){docid=this.docid;}
if(docid==undefined){return undefined;}
return'http://'+this.appHost+'/docs/'+docid+'/';},setLogging:function(f){f=(f==undefined)?true:f;this.fLogging=f;},log:function(message,obj){if(this.fLogging){if(obj!=undefined){console.log(message,obj);}
else{console.log(message);}}},errorHandler:function(xmlhttp,textStatus,errorThrown){this.changeState(this.stateSave);var code='ajax_error/'+xmlhttp.status;var message=xmlhttp.statusText;this.log(message+' ('+code+')',xmlhttp);this.errorReport(code,message);},errorReport:function(status,message){if(this.app.onError){this.app.onError(status,message);}
else{var formatted="client error: "+message+' ('+status+')';console.log(formatted);alert(formatted);}},confirmDiscard:function(){if(this.app.confirmDiscard){return this.app.confirmDiscard();}
return confirm(discardMessage);},setDirty:function(fDirty){if(fDirty==undefined){fDirty=true;}
if(!this.isDirty()&&fDirty){this.dirtyTime=new Date().getTime();}
this.changeState(fDirty?Client.states.dirty:Client.states.clean);},isDirty:function(){return this.state==Client.states.dirty;},changeState:function(state){if(state==this.state){return;}
var stateOld=this.state;this.state=state;if(this.app.onStateChange){this.app.onStateChange(state,stateOld);}},beforeUnload:function(evt){if(this.state!=Client.states.clean){evt.returnValue=unloadMessage;return evt.returnValue;}},poll:function(){if(this.lastHash!=location.hash){this.lastHash=location.hash;this.load(location.hash.substr(1));}
this.checkUsername();this.checkData();},checkUsername:function(){var sessionkey=cookies.getCookie('sessionkey');var usernameLast=this.username;if(sessionkey!==undefined){this.username=sessionkey.split('/')[1];}
else{this.username=undefined;}
if(this.app.onUserChange&&usernameLast!=this.username){this.log('found user: '+this.username);this.app.onUserChange(this.username);}},checkData:function(){if(this.saveInterval==0){return;}
if(this.isDirty()){if(this.username==undefined){return;}
var now=new Date().getTime();if(now-this.dirtyTime>this.saveInterval*1000){this.save();}
return;}
if(this.state!=Client.states.clean){return;}
var json=JSON.stringify(this.app.getData());if(json!=this.lastJSON){this.setDirty();}},signIn:function(){window.open('http://'+this.wwwHost+'/sign-in/'+
this.appid+'/','_blank');},signOut:function(){document.cookie='sessionkey=expired; path=/; expires='+'Sat, 01 Jan 2000 00:00:00 GMT';}});ns.extend({Client:Client});});
