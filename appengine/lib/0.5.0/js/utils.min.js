/* Begin file: namespace.js */
try{var console=(function(){if(console!=undefined){return console;}
var noop=function(){};var names=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];var consoleT={};for(var i=0;i<names.length;++i){consoleT[names[i]]=noop;}
return consoleT;}());}
catch(e){}
var namespace=(function(){try{if(namespace!=undefined){return namespace;}}
catch(e){}
function Namespace(parent,name){if(name){name=name.replace(/-/g,'_');}
this._isDefined=false;this._parent=parent;if(this._parent){this._parent[name]=this;this._path=this._parent._path;if(this._path!==''){this._path+='.';}
this._path+=name;}else{this._path='';}}
var namespaceT=new Namespace(null);function extendObject(dest,args){if(dest===undefined){dest={};}
for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var prop in source){if(source.hasOwnProperty(prop)){dest[prop]=source[prop];}}}
return dest;}
function copyArray(arg){return Array.prototype.slice.call(arg,0);}
Function.prototype.methods=function(obj){extendObject(this.prototype,obj);};Function.methods({fnMethod:function(obj){var _fn=this;return function(){return _fn.apply(obj,arguments);};},fnArgs:function(){var _fn=this;var _args=copyArray(arguments);return function(){var args=copyArray(arguments).concat(_args);var self=this;return _fn.apply(self,args);};}});Namespace.methods({define:function(callback){this._isDefined=true;console.info("Namespace '"+this._path+"' defined.");if(callback){callback(this);}
return this;},defineOnce:function(callback){if(this._isDefined){console.warn("WARNING: Namespace '"+this._path+"' redefinition.");return this;}
return this.define(callback);},extend:function(){var args=[this].concat(copyArray(arguments));return extendObject.apply(undefined,args);},nameOf:function(symbol){symbol=symbol.replace(/-/g,'_');return'namespace.'+this._sPath+'.'+symbol;}});extendObject(namespaceT,{lookup:function(path){path=path.replace(/-/g,'_');var parts=path.split('.');var cur=namespaceT;for(var i=0;i<parts.length;i++){var name=parts[i];if(cur[name]===undefined){cur=new Namespace(cur,name);}
else{cur=cur[name];}}
return cur;}});namespaceT.lookup('util').extend({extendObject:extendObject,copyArray:copyArray}).defineOnce();return namespaceT;}());
/* Begin file: base.js */
namespace.lookup('org.startpad.base').defineOnce(function(ns){var util=namespace.util;function Enum(args){var j=0;for(var i=0;i<arguments.length;i++){if(typeof arguments[i]=="string"){this[arguments[i]]=j++;}
else{j=arguments[i];}}}
Enum.methods({getName:function(value){for(var prop in this){if(this.hasOwnProperty(prop)){if(this[prop]==value)
return prop;}}}});function StBuf(){this.rgst=[];this.append.apply(this,arguments);}
StBuf.methods({append:function(){for(var ist=0;ist<arguments.length;ist++){this.rgst.push(arguments[ist].toString());}
return this;},clear:function(){this.rgst=[];},toString:function(){return this.rgst.join("");}});ns.extend({extendObject:util.extendObject,Enum:Enum,StBuf:StBuf,extendIfMissing:function(oDest,var_args){if(oDest==undefined){oDest={};}
for(var i=1;i<arguments.length;i++){var oSource=arguments[i];for(var prop in oSource){if(oSource.hasOwnProperty(prop)&&oDest[prop]==undefined){oDest[prop]=oSource[prop];}}}
return oDest;},extendDeep:function(dest){for(var i=1;i<arguments.length;i++){var src=arguments[i];for(var prop in src){if(src.hasOwnProperty(prop)){if(src[prop]instanceof Array){dest[prop]=[];ns.extendDeep(dest[prop],src[prop]);}
else if(src[prop]instanceof Object){dest[prop]={};ns.extendDeep(dest[prop],src[prop]);}
else{dest[prop]=src[prop];}}}}},randomInt:function(n){return Math.floor(Math.random()*n);},strip:function(s){return(s||"").replace(/^\s+|\s+$/g,"");},project:function(obj,asProps){var objT={};for(var i=0;i<asProps.length;i++){objT[asProps[i]]=obj[asProps[i]];}
return objT;},uniqueArray:function(a){if(!a){return;}
a.sort();for(var i=1;i<a.length;i++){if(a[i-1]==a[i]){a.splice(i,1);}}},map:function(a,fn){var aRes=[];for(var i=0;i<a.length;i++){aRes.push(fn(a[i]));}
return aRes;},filter:function(a,fn){var aRes=[];for(var i=0;i<a.length;i++){if(fn(a[i])){aRes.push(a[i]);}}
return aRes;},reduce:function(a,fn){if(a.length<2){return a[0];}
var res=a[0];for(var i=1;i<a.length-1;i++){res=fn(res,a[i]);}
return res;}});});
/* Begin file: misc.js */
namespace.lookup("com.pageforest.misc").define(function(ns){ns.strip=function(s){return(s||"").replace(/^\s+|\s+$/g,"");};});
/* Begin file: random.js */
namespace.lookup("com.pageforest.random").defineOnce(function(ns){ns.upper='ABCDEFGHIJKLMNOPQRSTUVWXYZ';ns.lower='abcdefghijklmnopqrstuvwxyz';ns.digits='0123456789';ns.base64=ns.upper+ns.lower+ns.digits+'+/';ns.base64url=ns.upper+ns.lower+ns.digits+'-_';ns.hexdigits=ns.digits+'abcdef';ns.random=function(len,chars){if(typeof chars=='undefined'){chars=ns.base64url;}
var radix=chars.length;var result=[];for(var i=0;i<len;i++){result[i]=chars[0|Math.random()*radix];}
return result.join('');};});
/* Begin file: cookies.js */
namespace.lookup('com.pageforest.cookies').define(function(ns){var misc=namespace.lookup('com.pageforest.misc');ns.extend({setCookie:function(name,value,days,path){var expires='';if(days){var date=new Date();date.setTime(date.getTime()+days*24*60*60*1000);expires='; expires='+date.toGMTString();}
path='; path='+(path||'/');document.cookie=encodeURIComponent(name)+'='+encodeURIComponent(value)
+expires+path;},getCookie:function(name){return ns.getCookies()[name];},getCookies:function(name){var st=document.cookie;var rgPairs=st.split(";");var obj={};for(var i=0;i<rgPairs.length;i++){rgPairs[i]=misc.strip(rgPairs[i]);var rgC=rgPairs[i].split("=");var val=decodeURIComponent(rgC[1]);var rg=val.match('^"(.*)"$');if(rg)
val=rg[1].replace('\\"','"');obj[decodeURIComponent(rgC[0])]=val;}
return obj;}});});
/* Begin file: client.js */
namespace.lookup('com.pageforest.client').defineOnce(function(ns){var cookies=namespace.lookup('com.pageforest.cookies');var base=namespace.lookup('org.startpad.base');var pollInterval=500;function Client(app){this.app=app;this.appHost=location.host;var dot=this.appHost.indexOf('.');this.appid=this.appHost.substr(0,dot);this.wwwHost='www'+this.appHost.substr(dot);this.lastHash='';this.state=Client.states.clean;this.username=undefined;this.fLogging=false;setInterval(this.poll.fnMethod(this),pollInterval);$(window).bind('beforeunload',this.beforeUnload.fnMethod(this));}
Client.states=new base.Enum('clean','dirty','loading','saving');Client.methods({load:function(docid){this.state=Client.states.loading;this.docid=docid;this.log("load: "+this.docid);$.ajax({dataType:'json',url:'http://'+this.appHost+'/docs/'+docid,error:this.errorHandler.fnMethod(this),success:function(document,textStatus,xmlhttp){this.state=Client.states.clean;this.app.loaded(document);}.fnMethod(this)});},save:function(json,docid){if(this.username==undefined){this.errorReport('no_username',"You must sign in to save.");}
if(docid!=undefined){this.docid=docid;}
if(this.docid==undefined){this.docid=this.username+'_'+base.randomInt(1000);}
this.state=Client.states.saving;if(!json.readers){json.readers=['public'];}
var data=JSON.stringify(json);this.log('save: '+this.docid,json);$.ajax({type:'PUT',url:'/docs/'+this.docid,data:data,error:this.errorHandler.fnMethod(this),success:function(data){this.log('saved');location.hash=this.docid;this.lastHash=location.hash;this.state=Client.states.clean;if(this.app.saved){this.app.saved();}}.fnMethod(this)});},setLogging:function(f){f=(f==undefined)?true:f;this.fLogging=f;},log:function(message,obj){if(this.fLogging){if(obj!=undefined){console.log(message,obj);}
else{console.log(message);}}},errorHandler:function(xmlhttp,textStatus,errorThrown){var code='ajax_error/'+xmlhttp.status;var message=xmlhttp.statusText;this.log(message+' ('+code+')',xmlhttp);this.errorReport(code,xmlhttp.statusText);},errorReport:function(status,message){if(this.app.error){this.app.error(status,message);}
else{alert(status+': '+message);}},makeDirty:function(fDirty){if(fDirty==undefined){fDirty=true;}
this.state=fDirty?Client.states.dirty:Client.states.clean;},beforeUnload:function(evt){if(this.state!=Client.states.clean){evt.returnValue="You will lose your changes if you leave "+"the window without saving.";return evt.returnValue;}},poll:function(){if(this.lastHash!=location.hash){this.lastHash=location.hash;this.load(location.hash.substr(1));}
this.checkUsername();},checkUsername:function(){var sessionkey=cookies.getCookie('sessionkey');var usernameLast=this.username;if(sessionkey!==undefined){this.username=sessionkey.split('/')[1];}
else{this.username=undefined;}
if(this.app.userChanged&&usernameLast!=this.username){this.log('found user: '+this.username);this.app.userChanged(this.username||'anonymous');}},signIn:function(){window.open('http://'+this.wwwHost+"/sign-in/scratch/",'_blank');},signOut:function(){document.cookie='sessionkey=expired; path=/; expires='+'Sat, 01 Jan 2000 00:00:00 GMT';}});ns.extend({Client:Client});});
