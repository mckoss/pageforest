namespace.lookup("com.pageforest.blocks").define(function(e){function j(){this.init(20,50)}var k=namespace.lookup("com.pageforest.client"),g=namespace.lookup("org.startpad.dom"),h=namespace.lookup("org.startpad.vector"),i=namespace.lookup("org.startpad.base");j.methods({constructor:j,faceEdges:["bbbb","wwbb","bwbb","wbww","bbww","wwww"],dxdy:[[0,-1],[1,0],[0,1],[-1,0]],init:function(a,b){this.rwMax=a;this.colMax=b;this.buildUI();this.generateOrder()},resize:function(){var a,b;try{a=this.checkNum("rows",
1,50),b=this.checkNum("columns",1,50)}catch(c){alert(c.message);return}this.init(a,b)},checkNum:function(a,b,c){var d=document.getElementById(a),f=parseInt(d.value);if(isNaN(f)||f<b||f>c)throw d.focus(),d.select(),Error(a+" must be a number between "+b+" and "+c+".");return f},buildUI:function(){this.divBoard=document.getElementById("divBoard");this.body=document.getElementsByTagName("body")[0];this.tbl&&this.divBoard.removeChild(this.tbl);this.tbl=document.createElement("table");this.cells=[];for(var a=
0;a<this.rwMax;a++){var b=document.createElement("tr");this.cells[a]=[];for(var c=0;c<this.colMax;c++){var d=document.createElement("td");this.cells[a][c]=document.createElement("div");this.cells[a][c].className="face";this.set(a,c,0,0);d.appendChild(this.cells[a][c]);b.appendChild(d)}this.tbl.appendChild(b)}this.divBoard.appendChild(this.tbl);g.bind(this.tbl,"mousedown",this.click.fnMethod(this));g.bind(window,"mouseup",this.mouseUp.fnMethod(this));g.bind(this.tbl,"mousemove",this.mouseMove.fnMethod(this));
a=document.getElementById("divTools");if(!this.tdTools){b=document.createElement("table");this.divTools=[];this.tdTools=[];c=document.createElement("tr");c.className="toolRow";for(d=0;d<6;d++){var f=document.createElement("td"),e=document.createElement("div");e.className="faceTools";e.style.backgroundPosition=this.imagePositionTools(d,0);g.bind(e,"mousedown",this.clickTool.fnMethod(this).fnArgs(d));e.iRot=0;f.appendChild(e);c.appendChild(f);this.divTools[d]=e;this.tdTools[d]=f}b.appendChild(c);c=
document.createElement("tr");c.className="rotRow";for(d=0;d<6;d++)f=document.createElement("td"),g.bind(f,"mousedown",this.clickRot.fnMethod(this).fnArgs(d)),c.appendChild(f);b.appendChild(c);a.appendChild(b);this.clickTool(null,5)}g.bind(window,"resize",this.resizeWindow.fnMethod(this));this.resizeWindow()},resizeWindow:function(){this.divBoard.style.width=this.tbl.offsetWidth+"px";this.ptTable=g.getPos(this.tbl)},click:function(a){a=this.rwColFromEvt(a);this.set(a[1],a[0],this.iTool,this.iRot);
this.ptLast=a;return!1},mouseMove:function(a){if(this.ptLast!=void 0){var b=this.rwColFromEvt(a);h.equal(b,this.ptLast)||this.click(a)}},mouseUp:function(){this.ptLast=void 0},rwColFromEvt:function(a){a=h.sub([a.pageX,a.pageY],this.ptTable);return h.floor(h.mult(a,1/21))},set:function(a,b,c,d){if(!(a<0||a>=this.rwMax||b<0||b>=this.colMax))a=this.get(a,b),a.iFace=c,a.iRot=d,a.style.backgroundPosition=this.imagePosition(c,c==5?i.randomInt(4):d)},get:function(a,b){if(!(a<0||a>=this.rwMax||b<0||b>=this.colMax))return this.cells[a][b]},
clickTool:function(a,b){if(b!=this.iTool){if(this.iTool!=void 0)this.tdTools[this.iTool].className="";this.tdTools[b].className="selected";this.iTool=b;this.iRot=this.divTools[b].iRot}},clickRot:function(a,b){this.clickTool(a,b);var c=this.divTools[b];c.iRot=(c.iRot+1)%4;this.iRot=c.iRot;c.style.backgroundPosition=this.imagePositionTools(b,c.iRot)},fill:function(){for(var a=0;a<this.order.length;a++)this.set(this.order[a][0],this.order[a][1],this.iTool,this.iRot)},randomize:function(){for(var a=0;a<
this.rwMax;a++)for(var b=0;b<this.colMax;b++)this.set(a,b,i.randomInt(6),i.randomInt(4))},invert:function(){for(var a=0;a<this.rwMax;a++)for(var b=0;b<this.colMax;b++){var c=this.get(a,b);this.set(a,b,5-c.iFace,c.iRot)}},generateOrder:function(){this.order=[];for(var a=0;a<this.rwMax;a++)for(var b=0;b<this.colMax;b++)this.order.push([a,b]);this.shuffle(this.order)},shuffle:function(a){for(var b=0;b<a.length;b++){var c=i.randomInt(a.length-b),d=a[b];a[b]=a[c];a[c]=d}},smooth:function(){this.generateOrder();
for(var a=0;a<this.order.length;a++){var b=this.order[a][0],c=this.order[a][1];this.get(b,c);var d=this.checkNeighbors(b,c);this.set(b,c,d[0],d[1])}},checkNeighbors:function(a,b){for(var c=this.get(a,b),d=this.neighborEdge(a,b),f=0;f<4;f++){if(/bwbw/.test(d)){if(c.iFace<3)return[0,0];return[5,0]}if(/bbww/.test(d)){if(c.iFace<3)return[1,(2+f)%4];return[4,f]}d=d.slice(1)+d.charAt(0)}return[c.iFace,c.iRot]},neighborEdge:function(a,b){for(var c="",d=0;d<4;d++){var f=a+this.dxdy[d][1],e=b+this.dxdy[d][0],
g=this.get(f,e);c+=f==-1||f==this.rwMax||e==-1||e==this.colMax?"b":this.faceEdges[g.iFace].charAt((6+d-g.iRot)%4)}return c},imagePositionTools:function(a,b){return-b*100+"px "+-a*100+"px"},imagePosition:function(a,b){return-b*20+"px "+-a*20+"px"},getCells:function(){for(var a=[],b=0;b<this.rwMax;b++){a[b]=[];for(var c=0;c<this.colMax;c++){var d=this.get(b,c);a[b][c]=[d.iFace,d.iRot]}}return a},setCells:function(a){for(var b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.length;d++)this.set(b,d,a[b][d][0],
a[b][d][1]);return this}});e.extend({onReady:function(){e.brd=new j;e.client=new k.Client(e);e.client.addAppBar();e.brd.resizeWindow();e.client.poll()},getDoc:function(){return{blob:{rows:e.brd.rwMax,cols:e.brd.colMax,cells:e.brd.getCells()},readers:["public"]}},setDoc:function(a){a=a.blob;this.brd.init(a.rows,a.cols);this.brd.setCells(a.cells)}})});