namespace.lookup("com.pageforest.client.test").defineOnce(function(l){function f(g){this.ut=g}var m=namespace.lookup("com.pageforest.client"),k={testNum:1,testString:"hello",testBool:!1,testObj:{a:1,b:2},testArray:[1,2,3]};f.methods({getDoc:function(){return{blob:"hello"}},setDoc:function(g){console.log("setDoc",g);this.restore=g},onStateChange:function(g){this.state=g;if(this.expectedState)this.ut.assertEq(g,this.expectedState),this.expectedState=void 0,this.ut.nextFn()},getDocid:function(){return"test-1"},
setDocid:function(){}});var i=new f,g=new m.Client(i);l.addTests=function(f){f.addTest("Client",function(e){f.coverage.cover("Client");e.assert(g!=void 0)});f.addTest("save/load",function(e){i.ut=e;g.detach();g.setDirty(!1);e.asyncSequence([function(e){g.username!=void 0?e.nextFn():(e.assertEq(g.username,void 0,"not yet logged in"),i.onUserChange=function(f){i.onUserChange=void 0;e.assertType(f,"string");e.assertEq(g.state,"loading");e.nextFn()},g.poll())},function(e){e.assertEq(g.getDocURL(),"/docs/test-1/");
i.expectedState="saving";g.save({title:"A testing document.",blob:k},"test-1")},function(){i.expectedState="clean"},function(e){var f=g.getDocURL();e.assertEq(f.indexOf("/test-1"),f.length-8);i.expectedState="loading";g.load("test-1")},function(){i.expectedState="clean"},function(e){e.assertEq(i.restore.blob,k);e.nextFn()}])}).async(!0);f.addTest("Client UI",function(e){i.ut=e;g.addAppBar();e.assertEq($("#pfAppBar").length,1);e.assertGT($("#pfUsername").text().length,0,"Username should be displayed")})}});namespace.lookup("com.pageforest.scratch.test").defineOnce(function(l){l.extend({addTests:function(f){f.addTest("Scratch Unit Tests",function(f){f.assert(!0)})}})});namespace.lookup("com.pageforest.storage.test").defineOnce(function(l){function f(b){this.ut=b;this.waitingFor=this.ignore=void 0;this.skip=!0}var m=namespace.lookup("com.pageforest.client"),k=namespace.lookup("com.pageforest.storage"),i=namespace.lookup("org.startpad.format"),g=namespace.lookup("org.startpad.base"),n=namespace.lookup("com.googlecode.crypto-js"),e={testNum:1,testString:"hello",testBool:!1,testObj:{a:1,b:2},testArray:[1,2,3]},o=k.jsonToString(e),p=n.SHA1(o);f.methods({expectedError:function(b){this.ignore=
b;this.skip=!0},onError:function(b,d){if(this.ignore){if(this.ut.assertEq(b,this.ignore),b==this.ignore&&this.skip)this.ignore=void 0,this.ut.nextFn()}else this.ut.assert(!1,"Unexpected error: "+b+" ("+d+")")},onInfo:function(b){this.waitingFor&&this.waitingFor==b&&(delete this.waitingFor,this.ut.nextFn())},setDocid:function(){},getDocid:function(){return"test-1"}});var b=new m.Client(new f);l.addTests=function(f){f.addTest("Storage",function(d){d.assert(b.storage!=void 0);f.coverage.cover("Storage")});
f.addTest("getDocURL",function(d){d.assertEq(b.appHost.indexOf("scratch.pageforest"),0);var h=b.storage.getDocURL("foo","bar");d.assertEq(h.indexOf("/docs/foo/bar"),h.length-13);var a=b.storage.getDocURL("foo");d.assertEq(a,h.substr(0,h.length-3));h=b.storage.getDocURL();d.assertEq(h.indexOf("/docs/"),h.length-6)});f.addTest("Docs: put/get/delete",function(d){function h(){d.nextFn()}b.app.ut=d;d.asyncSequence([function(a){b.app.onUserChange=function(c){b.app.onUserChange=void 0;a.assertType(c,"string");
a.assertEq(b.state,"clean");a.nextFn()};if(b.username==void 0)b.poll();else b.app.onUserChange(b.username)},function(){b.storage.putDoc("test-storage",{title:"Test storage document.",blob:e},h)},function(){b.storage.putBlob("test-storage","secret-blob",{secret:"password"},void 0,h)},function(a){b.storage.getDoc("test-storage",function(c){a.assertEq(c.title,"Test storage document.");a.assertEq(c.blob,e);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getDoc("does-not-exist",
function(){a.assert(!1,"Should never call callback.");a.nextFn()})},function(a){b.storage.deleteDoc("test-storage",function(c){a.assertEq(c.status,200);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getDoc("test-storage",function(){a.assert(!1,"Document not actually deleted.");a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","secret-blob",void 0,function(){a.assert(!1,"Child Blob of deleted document visible.");a.nextFn()})},
function(){b.storage.putDoc("test-storage",{title:"Test storage document.",blob:e},h)},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","secret-blob",void 0,function(){a.assert(!1,"Orphaned Blob of deleted document visible.");a.nextFn()})}])}).async();f.addTest("Blobs: put/get/delete",function(d){var h;b.app.ut=d;d.asyncSequence([function(a){b.storage.putBlob("test-storage","test-blob",e,void 0,function(c){h=c.sha1;a.assertEq(c.status,200);a.nextFn()})},function(a){b.storage.getBlob("test-storage",
"test-blob",void 0,function(c,b,q){a.assertEq(c,e);a.assertEq(k.getEtag(q),h);a.nextFn()})},function(a){b.storage.deleteBlob("test-storage","test-blob",function(c){a.assertEq(c.status,200);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","test-blob",void 0,function(){a.assert(!1,"unreachable")})}])}).async();f.addTest("list",function(d){function h(a){d.assertEq(a.status,200);d.nextFn()}b.app.ut=d;var a,c;d.asyncSequence([function(){b.storage.putBlob("test-storage",
"test-blob1",e,void 0,h)},function(){b.storage.putBlob("test-storage","test-blob2",e,void 0,h)},function(a){b.storage.list(void 0,void 0,{},function(c){a.assertType(c.items,"object");a.assertType(c.items["test-storage"],"object");a.nextFn()})},function(j){b.storage.list("test-storage",void 0,{},function(b){j.assertType(b.items,Object);var d=b.items["test-blob1"];b=b.items["test-blob2"];j.assertType(d,"object");j.assertType(b,"object");j.assertEq(d.json,!0);j.assertEq(d.sha1,p);j.assertEq(d.sha1,b.sha1);
j.assertEq(d.size,b.size);a=i.decodeClass(d.modified);c=i.decodeClass(b.modified);j.assertType(a,Date);j.assertLT(a,c);j.nextFn()})},function(a){b.storage.list("test-storage",void 0,{keysonly:!0},function(c){a.assertType(c.items,"object");a.assertEq(c.items["test-blob1"],{});a.assertEq(c.items["test-blob2"],{});a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{order:"modified"},function(c){a.assertEq(c.order,["test-blob1","test-blob2"]);a.nextFn()})},function(a){b.storage.list("test-storage",
void 0,{order:"-modified"},function(c){a.assertEq(c.order,["test-blob2","test-blob1"]);a.nextFn()})},function(c){var d=new Date;d.setTime(a.getTime()+1);console.log(i.isoFromDate(a),i.isoFromDate(d));b.storage.list("test-storage",void 0,{since:d},function(a){c.assert("test-blob2"in a.items,"missing newest blob");c.assert(!("test-blob1"in a.items),"has too old blob");c.nextFn()})}])}).async(!0,15E3);f.addTest("list prefix and tag",function(d){function h(a){d.assertEq(a.status,200);d.nextFn()}b.app.ut=
d;d.asyncSequence([function(){b.storage.putBlob("test-storage","test-tag1",e,{tags:["tag1","tag2"]},h)},function(){b.storage.putBlob("test-storage","test-tag2",e,{tags:["tag2"]},h)},function(a){b.storage.list("test-storage",void 0,{prefix:"test-b"},function(c){c=c.items;a.assertType(c,"object");a.assertEq(g.keys(c).length,2);a.assert(c.hasOwnProperty("test-blob1"));a.assert(c.hasOwnProperty("test-blob2"));a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{tag:"tag2"},function(c){c=c.items;
a.assertType(c,"object");a.assertEq(g.keys(c).length,2);a.assert(c.hasOwnProperty("test-tag1"));a.assert(c.hasOwnProperty("test-tag2"));a.assertEq(c["test-tag1"].tags,["tag1","tag2"]);a.assertEq(c["test-tag2"].tags,["tag2"]);a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{tag:"tag1"},function(c){c=c.items;a.assertType(c,"object");a.assertEq(g.keys(c).length,1);a.assert(c.hasOwnProperty("test-tag1"));a.nextFn()})}])}).async();f.addTest("list depth",function(d){b.app.ut=d;var h=["root",
"root/child1","root/child2","root/child1/child3"];d.asyncSequence([function(a){function c(){b.storage.putBlob("test-storage",h[d],e,void 0,function(b){a.assertEq(b.status,200);++d<h.length?setTimeout(c,1):a.nextFn()})}var d=0;c()},function(a){b.storage.list("test-storage","root",{},function(c){c=c.items;a.assertEq(g.keys(c).length,2);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.nextFn()})},function(a){b.storage.list("test-storage","root",{depth:1},function(c){c=c.items;
a.assertEq(g.keys(c).length,2);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.nextFn()})},function(a){b.storage.list("test-storage","root",{depth:0},function(c){c=c.items;a.assertEq(g.keys(c).length,3);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.assert(c.hasOwnProperty("child1/child3"));a.nextFn()})}])}).async();f.addTest("push/slice",function(d){b.app.ut=d;var h=[[void 0,void 0,[0,1,2,3,4,5,6,7,8,9]],[-5,void 0,[5,6,7,8,9]],[void 0,5,[0,
1,2,3,4]],[2,7,[2,3,4,5,6]]];d.asyncSequence([function(a){b.app.expectedError("ajax_error/404");b.storage.deleteBlob("test-storage","test-array",function(c){b.app.expectedError();a.assert(c.status,200);a.nextFn()})},function(a){function c(){b.storage.push("test-storage","test-array",d++,{},function(b){a.assertEq(b.status,200);d==10?a.nextFn():setTimeout(c,1)})}var d=0;c()},function(a){b.storage.getBlob("test-storage","test-array",{},function(c){a.assertEq(c,[0,1,2,3,4,5,6,7,8,9]);a.nextFn()})},function(a){function c(){var e=
h[d++];b.storage.slice("test-storage","test-array",{start:e[0],end:e[1]},function(b){a.assertEq(b,e[2]);d==h.length?a.nextFn():setTimeout(c,1)})}this.ut=a;var d=0;c()},function(a){b.app.expectedError("slice_range");b.storage.slice("test-storage","test-array",{start:"foo"},function(){a.assert(!1,"unreachable")})},function(a){b.app.expectedError("ajax_error/404");b.storage.slice("test-storage","does-not-exist",{start:0,end:0},function(){a.assert(!1,"unreachable")})},function(a){b.storage.push("test-storage",
"test-array","new",{max:5},function(c){a.assertEq(c.newLength,5);a.nextFn()})},function(a){b.storage.getBlob("test-storage","test-array",{},function(c){a.assertEq(c,[6,7,8,9,"new"]);a.nextFn()})}])}).async(!0,15E3);f.addTest("wait",function(d){b.app.ut=d;var e;d.asyncSequence([function(a){b.storage.putBlob("test-storage","test-wait",[1,2,3,4,5],void 0,function(c){e=c.sha1;a.assertEq(c.status,200);a.nextFn()})},function(a){var c=(new Date).getTime();b.storage.getBlob("test-storage","test-wait",void 0,
function(b,d,f){b=(new Date).getTime();a.assertLT(b-c,500);a.assertEq(k.getEtag(f),e);a.nextFn()})},function(a){var c=(new Date).getTime();b.storage.getBlob("test-storage","test-wait",{wait:3},function(b,d,f){b=(new Date).getTime();a.assertGT(b-c,3E3);a.assertEq(k.getEtag(f),e);a.nextFn()})}])}).async(!0,15E3).enable(!1);f.addTest("channel",function(d){b.app.ut=d;b.app.ignore="channel/nosub";b.app.skip=!1;b.app.waitingFor="channel/updated";var f,a;d.asyncSequence([function(a){a.assert(!b.storage.hasSubscription("test-storage",
"test-channel"));b.storage.subscribe("test-storage","test-channel",void 0,function(b){a.assertEq(b.app,"scratch");a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/test-channel/");f==void 0?f=b.data.sha1:a.assertEq(b.data.sha1,f);a.nextFn()});a.assert(b.storage.hasSubscription("test-storage","test-channel"))},function(a){b.storage.putBlob("test-storage","test-channel",[1,2,3,4,5],void 0,function(b){a.assertEq(b.status,200);f==void 0?f=b.sha1:a.assertEq(b.sha1,f)})},function(c){var d=(new Date).getTime();
b.storage.subscribe("test-storage","test-channel",void 0,function(b){var e=(new Date).getTime();c.assertGT(e-d,1E3);c.assertEq(b.key,"test-storage/test-channel/");c.assertEq(b.method,"PUSH");a==void 0?a=b.data.sha1:(c.assertEq(b.data.sha1,a),c.assertNEq(a,f),c.nextFn())});setTimeout(function(){b.storage.push("test-storage","test-channel",6,void 0,function(b){c.assertEq(b.status,200);a==void 0?a=b.newSha1:(c.assertEq(b.newSha1,a),c.assertNEq(a,f),c.nextFn())})},1E3)},function(a){var d=(new Date).getTime();
b.storage.subscribe("test-storage",void 0,void 0,function(b){var e=(new Date).getTime();a.assertGT(e-d,1E3);a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/");a.nextFn()});setTimeout(function(){b.storage.putDoc("test-storage",{title:"Test storage document - channel update.",blob:e},function(b){a.assertEq(b.status,200)})},1E3)},function(a){var d=(new Date).getTime();b.storage.subscribe("test-storage",void 0,{children:!0},function(b){if(b.key=="test-storage/test-blob-2/"){console.log("Calling parent callback");
var e=(new Date).getTime();a.assertGT(e-d,1E3);a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/test-blob-2/");a.nextFn()}});setTimeout(function(){b.storage.putBlob("test-storage","test-blob-2",{title:"Test storage document - channel update.",blob:e},void 0,function(b){a.assertEq(b.status,200)})},1E3)}])}).async(!0,3E4);f.addTest("Anonymous public",function(d){function f(){d.nextFn()}b.ignore=void 0;d.asyncSequence([function(){b.storage.putDoc("test-public",{title:"Public storage document.",
blob:e,readers:["public"],writers:["public"]},f)},function(a){b.storage.putBlob("test-public","test-blob",e,void 0,function(b){etag=b.sha1;a.assertEq(b.status,200);a.nextFn()})},function(a){b.app.onUserChange=function(c){b.app.onUserChange=void 0;a.assertEq(c,void 0);a.nextFn()};b.signOut();b.poll()},function(a){b.storage.putBlob("test-public","test-blob",e,void 0,function(b){etag=b.sha1;a.assertEq(b.status,200);a.nextFn()})}])}).async();f.addTest("Error callback",function(d){b.storage.getBlob("test-storage",
"does-not-exists",{error:function(){d.assert(!0);d.async(!1)}},function(){d.assert(!1);d.async(!1)})}).async(!0)}});