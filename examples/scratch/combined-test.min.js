namespace.lookup("com.pageforest.client.test").defineOnce(function(l){function g(h){this.ut=h}var m=namespace.lookup("com.pageforest.client"),k={testNum:1,testString:"hello",testBool:!1,testObj:{a:1,b:2},testArray:[1,2,3]};g.methods({getDoc:function(){return{blob:"hello"}},setDoc:function(h){console.log("setDoc",h);this.restore=h},onStateChange:function(h){this.state=h;if(this.expectedState)this.ut.assertEq(h,this.expectedState),this.expectedState=void 0,this.ut.nextFn()},getDocid:function(){return"test-1"},
setDocid:function(){}});var i=new g,h=new m.Client(i);l.addTests=function(g){g.addTest("Client",function(f){g.coverage.cover("Client");f.assert(h!=void 0)});g.addTest("save/load",function(f){i.ut=f;h.detach();h.setDirty(!1);f.asyncSequence([function(f){h.username!=void 0?f.nextFn():(f.assertEq(h.username,void 0,"not yet logged in"),i.onUserChange=function(g){i.onUserChange=void 0;f.assertType(g,"string");f.assertEq(h.state,"loading");f.nextFn()},h.poll())},function(f){f.assertEq(h.getDocURL(),"/docs/test-1/");
i.expectedState="saving";h.save({title:"A testing document.",blob:k},"test-1")},function(){i.expectedState="clean"},function(f){var g=h.getDocURL();f.assertEq(g.indexOf("/test-1"),g.length-8);i.expectedState="loading";h.load("test-1")},function(){i.expectedState="clean"},function(f){f.assertEq(i.restore.blob,k);f.nextFn()}])}).async(!0);g.addTest("Client UI",function(f){i.ut=f;h.addAppBar();f.assertEq($("#pfAppBar").length,1);f.assertGT($("#pfUsername").text().length,0,"Username should be displayed")})}});namespace.lookup("com.pageforest.scratch.test").defineOnce(function(l){l.extend({addTests:function(g){g.addTest("Scratch Unit Tests",function(g){g.assert(!0)})}})});namespace.lookup("com.pageforest.storage.test").defineOnce(function(l){function g(b){this.ut=b;this.waitingFor=this.ignore=void 0;this.skip=!0}var m=namespace.lookup("com.pageforest.client"),k=namespace.lookup("com.pageforest.storage"),i=namespace.lookup("org.startpad.format"),h=namespace.lookup("org.startpad.base"),n=namespace.lookup("com.googlecode.crypto-js"),f={testNum:1,testString:"hello",testBool:!1,testObj:{a:1,b:2},testArray:[1,2,3]},o=k.jsonToString(f),p=n.SHA1(o);g.methods({expectedError:function(b){this.ignore=
b;this.skip=!0},onError:function(b,e){if(this.ignore){if(this.ut.assertEq(b,this.ignore),b==this.ignore&&this.skip)this.ignore=void 0,this.ut.nextFn()}else this.ut.assert(!1,"Unexpected error: "+b+" ("+e+")")},onInfo:function(b){this.waitingFor&&this.waitingFor==b&&(delete this.waitingFor,this.ut.nextFn())},setDocid:function(){},getDocid:function(){return"test-1"}});var b=new m.Client(new g);l.addTests=function(g){g.addTest("Storage",function(e){e.assert(b.storage!=void 0);g.coverage.cover("Storage")});
g.addTest("getDocURL",function(e){e.assertEq(b.appHost.indexOf("scratch.pageforest"),0);var d=b.storage.getDocURL("foo","bar");e.assertEq(d.indexOf("/docs/foo/bar"),d.length-13);var a=b.storage.getDocURL("foo");e.assertEq(a,d.substr(0,d.length-3));d=b.storage.getDocURL();e.assertEq(d.indexOf("/docs/"),d.length-6)});g.addTest("Docs: put/get/delete",function(e){function d(){e.nextFn()}b.app.ut=e;e.asyncSequence([function(a){b.app.onUserChange=function(c){b.app.onUserChange=void 0;a.assertType(c,"string");
a.assertEq(b.state,"clean");a.nextFn()};if(b.username==void 0)b.poll();else b.app.onUserChange(b.username)},function(){b.storage.putDoc("test-storage",{title:"Test storage document.",blob:f},d)},function(){b.storage.putBlob("test-storage","secret-blob",{secret:"password"},void 0,d)},function(a){b.storage.getDoc("test-storage",function(c){a.assertEq(c.title,"Test storage document.");a.assertEq(c.blob,f);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getDoc("does-not-exist",
function(){a.assert(!1,"Should never call callback.");a.nextFn()})},function(a){b.storage.deleteDoc("test-storage",function(c){a.assertEq(c.status,200);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getDoc("test-storage",function(){a.assert(!1,"Document not actually deleted.");a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","secret-blob",void 0,function(){a.assert(!1,"Child Blob of deleted document visible.");a.nextFn()})},
function(){b.storage.putDoc("test-storage",{title:"Test storage document.",blob:f},d)},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","secret-blob",void 0,function(){a.assert(!1,"Orphaned Blob of deleted document visible.");a.nextFn()})}])}).async();g.addTest("Blobs: put/get/delete",function(e){var d;b.app.ut=e;e.asyncSequence([function(a){b.storage.putBlob("test-storage","test-blob",f,void 0,function(c){d=c.sha1;a.assertEq(c.status,200);a.nextFn()})},function(a){b.storage.getBlob("test-storage",
"test-blob",void 0,function(c,b,q){a.assertEq(c,f);a.assertEq(k.getEtag(q),d);a.nextFn()})},function(a){b.storage.deleteBlob("test-storage","test-blob",function(c){a.assertEq(c.status,200);a.nextFn()})},function(a){b.app.expectedError("ajax_error/404");b.storage.getBlob("test-storage","test-blob",void 0,function(){a.assert(!1,"unreachable")})}])}).async();g.addTest("list",function(e){function d(a){e.assertEq(a.status,200);e.nextFn()}b.app.ut=e;var a,c;e.asyncSequence([function(){b.storage.putBlob("test-storage",
"test-blob1",f,void 0,d)},function(){b.storage.putBlob("test-storage","test-blob2",f,void 0,d)},function(a){b.storage.list(void 0,void 0,{},function(c){a.assertType(c.items,"object");a.assertType(c.items["test-storage"],"object");a.nextFn()})},function(j){b.storage.list("test-storage",void 0,{},function(b){j.assertType(b.items,Object);var d=b.items["test-blob1"];b=b.items["test-blob2"];j.assertType(d,"object");j.assertType(b,"object");j.assertEq(d.json,!0);j.assertEq(d.sha1,p);j.assertEq(d.sha1,b.sha1);
j.assertEq(d.size,b.size);a=i.decodeClass(d.modified);c=i.decodeClass(b.modified);j.assertType(a,Date);j.assertLT(a,c);j.nextFn()})},function(a){b.storage.list("test-storage",void 0,{keysonly:!0},function(c){a.assertType(c.items,"object");a.assertEq(c.items["test-blob1"],{});a.assertEq(c.items["test-blob2"],{});a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{order:"modified"},function(c){a.assertEq(c.order,["test-blob1","test-blob2"]);a.nextFn()})},function(a){b.storage.list("test-storage",
void 0,{order:"-modified"},function(c){a.assertEq(c.order,["test-blob2","test-blob1"]);a.nextFn()})},function(c){var d=new Date;d.setTime(a.getTime()+1);console.log(i.isoFromDate(a),i.isoFromDate(d));b.storage.list("test-storage",void 0,{since:d},function(a){c.assert("test-blob2"in a.items,"missing newest blob");c.assert(!("test-blob1"in a.items),"has too old blob");c.nextFn()})}])}).async(!0,15E3);g.addTest("list prefix and tag",function(e){function d(a){e.assertEq(a.status,200);e.nextFn()}b.app.ut=
e;e.asyncSequence([function(){b.storage.putBlob("test-storage","test-tag1",f,{tags:["tag1","tag2"]},d)},function(){b.storage.putBlob("test-storage","test-tag2",f,{tags:["tag2"]},d)},function(a){b.storage.list("test-storage",void 0,{prefix:"test-b"},function(c){c=c.items;a.assertType(c,"object");a.assertEq(h.keys(c).length,2);a.assert(c.hasOwnProperty("test-blob1"));a.assert(c.hasOwnProperty("test-blob2"));a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{tag:"tag2"},function(c){c=c.items;
a.assertType(c,"object");a.assertEq(h.keys(c).length,2);a.assert(c.hasOwnProperty("test-tag1"));a.assert(c.hasOwnProperty("test-tag2"));a.assertEq(c["test-tag1"].tags,["tag1","tag2"]);a.assertEq(c["test-tag2"].tags,["tag2"]);a.nextFn()})},function(a){b.storage.list("test-storage",void 0,{tag:"tag1"},function(c){c=c.items;a.assertType(c,"object");a.assertEq(h.keys(c).length,1);a.assert(c.hasOwnProperty("test-tag1"));a.nextFn()})}])}).async();g.addTest("list depth",function(e){b.app.ut=e;var d=["root",
"root/child1","root/child2","root/child1/child3"];e.asyncSequence([function(a){function c(){b.storage.putBlob("test-storage",d[j],f,void 0,function(b){a.assertEq(b.status,200);++j<d.length?setTimeout(c,1):a.nextFn()})}var j=0;c()},function(a){b.storage.list("test-storage","root",{},function(c){c=c.items;a.assertEq(h.keys(c).length,2);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.nextFn()})},function(a){b.storage.list("test-storage","root",{depth:1},function(c){c=c.items;
a.assertEq(h.keys(c).length,2);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.nextFn()})},function(a){b.storage.list("test-storage","root",{depth:0},function(c){c=c.items;a.assertEq(h.keys(c).length,3);a.assert(c.hasOwnProperty("child1"));a.assert(c.hasOwnProperty("child2"));a.assert(c.hasOwnProperty("child1/child3"));a.nextFn()})}])}).async();g.addTest("push/slice",function(e){b.app.ut=e;var d=[[void 0,void 0,[0,1,2,3,4,5,6,7,8,9]],[-5,void 0,[5,6,7,8,9]],[void 0,5,[0,
1,2,3,4]],[2,7,[2,3,4,5,6]]];e.asyncSequence([function(a){b.app.expectedError("ajax_error/404");b.storage.deleteBlob("test-storage","test-array",function(c){b.app.expectedError();a.assert(c.status,200);a.nextFn()})},function(a){function c(){b.storage.push("test-storage","test-array",d++,{},function(b){a.assertEq(b.status,200);d==10?a.nextFn():setTimeout(c,1)})}var d=0;c()},function(a){b.storage.getBlob("test-storage","test-array",{},function(c){a.assertEq(c,[0,1,2,3,4,5,6,7,8,9]);a.nextFn()})},function(a){function c(){var f=
d[e++];b.storage.slice("test-storage","test-array",{start:f[0],end:f[1]},function(b){a.assertEq(b,f[2]);e==d.length?a.nextFn():setTimeout(c,1)})}this.ut=a;var e=0;c()},function(a){b.app.expectedError("slice_range");b.storage.slice("test-storage","test-array",{start:"foo"},function(){a.assert(!1,"unreachable")})},function(a){b.app.expectedError("ajax_error/404");b.storage.slice("test-storage","does-not-exist",{start:0,end:0},function(){a.assert(!1,"unreachable")})},function(a){b.storage.push("test-storage",
"test-array","new",{max:5},function(c){a.assertEq(c.newLength,5);a.nextFn()})},function(a){b.storage.getBlob("test-storage","test-array",{},function(c){a.assertEq(c,[6,7,8,9,"new"]);a.nextFn()})}])}).async(!0,15E3);g.addTest("wait",function(e){b.app.ut=e;var d;e.asyncSequence([function(a){b.storage.putBlob("test-storage","test-wait",[1,2,3,4,5],void 0,function(c){d=c.sha1;a.assertEq(c.status,200);a.nextFn()})},function(a){var c=(new Date).getTime();b.storage.getBlob("test-storage","test-wait",void 0,
function(b,e,f){b=(new Date).getTime();a.assertLT(b-c,500);a.assertEq(k.getEtag(f),d);a.nextFn()})},function(a){var c=(new Date).getTime();b.storage.getBlob("test-storage","test-wait",{wait:3},function(b,f,e){b=(new Date).getTime();a.assertGT(b-c,3E3);a.assertEq(k.getEtag(e),d);a.nextFn()})}])}).async(!0,15E3).enable(!1);g.addTest("channel",function(e){b.app.ut=e;b.app.ignore="channel/nosub";b.app.skip=!1;b.app.waitingFor="channel/updated";var d,a;e.asyncSequence([function(a){a.assert(!b.storage.hasSubscription("test-storage",
"test-channel"));b.storage.subscribe("test-storage","test-channel",void 0,function(b){a.assertEq(b.app,"scratch");a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/test-channel/");d==void 0?d=b.data.sha1:a.assertEq(b.data.sha1,d);a.nextFn()});a.assert(b.storage.hasSubscription("test-storage","test-channel"))},function(a){b.storage.putBlob("test-storage","test-channel",[1,2,3,4,5],void 0,function(b){a.assertEq(b.status,200);d==void 0?d=b.sha1:a.assertEq(b.sha1,d)})},function(c){var e=(new Date).getTime();
b.storage.subscribe("test-storage","test-channel",void 0,function(b){var f=(new Date).getTime();c.assertGT(f-e,1E3);c.assertEq(b.key,"test-storage/test-channel/");c.assertEq(b.method,"PUSH");a==void 0?a=b.data.sha1:(c.assertEq(b.data.sha1,a),c.assertNEq(a,d),c.nextFn())});setTimeout(function(){b.storage.push("test-storage","test-channel",6,void 0,function(b){c.assertEq(b.status,200);a==void 0?a=b.newSha1:(c.assertEq(b.newSha1,a),c.assertNEq(a,d),c.nextFn())})},1E3)},function(a){var d=(new Date).getTime();
b.storage.subscribe("test-storage",void 0,void 0,function(b){var e=(new Date).getTime();a.assertGT(e-d,1E3);a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/");a.nextFn()});setTimeout(function(){b.storage.putDoc("test-storage",{title:"Test storage document - channel update.",blob:f},function(b){a.assertEq(b.status,200)})},1E3)},function(a){var d=(new Date).getTime();b.storage.subscribe("test-storage",void 0,{children:!0},function(b){if(b.key=="test-storage/test-blob-2/"){console.log("Calling parent callback");
var e=(new Date).getTime();a.assertGT(e-d,1E3);a.assertEq(b.method,"PUT");a.assertEq(b.key,"test-storage/test-blob-2/");a.nextFn()}});setTimeout(function(){b.storage.putBlob("test-storage","test-blob-2",{title:"Test storage document - channel update.",blob:f},void 0,function(b){a.assertEq(b.status,200)})},1E3)}])}).async(!0,3E4);g.addTest("Anonymous public",function(e){function d(){e.nextFn()}b.ignore=void 0;e.asyncSequence([function(){b.storage.putDoc("test-public",{title:"Public storage document.",
blob:f,readers:["public"],writers:["public"]},d)},function(a){b.storage.putBlob("test-public","test-blob",f,void 0,function(b){etag=b.sha1;a.assertEq(b.status,200);a.nextFn()})},function(a){b.app.onUserChange=function(c){b.app.onUserChange=void 0;a.assertEq(c,void 0);a.nextFn()};b.signOut();b.poll()},function(a){b.storage.putBlob("test-public","test-blob",f,void 0,function(b){etag=b.sha1;a.assertEq(b.status,200);a.nextFn()})}])}).async()}});