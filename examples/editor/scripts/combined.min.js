(function(i){function f(){}function e(d){if(!d)return 0;d=d.split(".");return 1E4*parseInt(d[0])+100*parseInt(d[1])+parseInt(d[2])}function h(d){for(var d=d.replace(/-/g,"_"),d=d.split("."),e=b,g=0;g<d.length;g++)e[d[g]]===void 0&&(e[d[g]]=new f),e=e[d[g]];return e}var b=i.namespace;if(b){if(e("3.0.1")<=e(b.VERSION))return;f=b.constructor}else i.namespace=b=new f;b.VERSION="3.0.1";i=f.prototype;i.module=function(d,b){var g=h(d);b&&b(g,h);return g};i.extend=function(d){for(var b in d)d.hasOwnProperty(b)&&
(this[b]=d[b])}})(this);
namespace.module("org.startpad.types",function(i){function f(g,b){return e(g)==b}function e(g){if(g===void 0)return"undefined";if(g===null)return"null";var d=Object.prototype.toString.call(g).match(/\[object (.*)\]/)[1].toLowerCase();b.indexOf(d)==-1&&(d=typeof g);return d}function h(d){var b=[],e;for(e in d)d.hasOwnProperty(e)&&b.push(e);return b}i.extend({VERSION:"0.2.2",isArguments:function(d){return f(d,"arguments")},isArray:function(d){return f(d,"array")},copyArray:function(d){return Array.prototype.slice.call(d)},isType:f,
typeOf:e,extend:function(b){var e,f,c,a;b===void 0&&(b={});for(e=1;e<arguments.length;e++){c=arguments[e];for(a in c)c.hasOwnProperty(a)&&(b[a]=c[a]);if(d)for(f=0;f<j.length;f++)a=j[f],c.hasOwnProperty(a)&&(b[a]=c[a])}return b},project:function(d,b){var e={};typeof b=="string"&&(b=[b]);for(var c=0;c<b.length;c++){var a=b[c];d&&d.hasOwnProperty(a)&&(e[a]=d[a])}return e},getFunctionName:function(b){if(typeof b=="function")return b=b.toString().match(/function\s*(\S+)\s*\(/),!b?"":b[1]},keys:Object.keys||
h,patch:function(){Object.keys=Object.keys||h;return i}});var b="number,string,boolean,array,function,date,regexp,arguments,undefined,null".split(","),d=!{toString:!0}.propertyIsEnumerable("toString"),j=["toString","toLocaleString","valueOf","constructor","isPrototypeOf"]});
namespace.module("org.startpad.funcs",function(i,f){function e(a){if(!a)return 0;a=a.split(".");return 1E4*parseInt(a[0])+100*parseInt(a[1])+parseInt(a[2])}function h(a,c,d,f){if(!(a._patches&&e(a._patches[c])>=e(d)))a._patches=a._patches||{},a._patches[c]=d,b(a,f)}function b(a,b){c.extend(a.prototype,b)}function d(a,b){function d(a,b){for(var k=c.copyArray(a),b=c.copyArray(b),e=0;e<k.length;e++)k[e]===void 0&&(k[e]=b.shift());return k.concat(b)}var e;e=arguments.length==3&&c.isArguments(arguments[2])?
Array.prototype.slice.call(arguments[2],self1):Array.prototype.slice.call(arguments,2);return function(){return a.apply(b||this,d(e,arguments))}}function j(a,c){function b(){return c.call(this,a,arguments,b)}c.call(a,void 0,arguments,b);return b}function g(a){function c(){}c.prototype=a;return new c}function l(a,c,d){a.prototype=i.create(c.prototype);a.prototype.constructor=a;b(a,d);return a}function m(a,d){for(var e=a.pop().prototype,f;a.length>0;){f=a.pop();var g=c.getFunctionName(f),h=i.create(e);
c.extend(h,f.prototype);h.constructor=f;h[g+"_super"]=e;e=h}f.prototype=e;b(f,d)}var c=f("org.startpad.types");i.extend({VERSION:"0.3.1",methods:b,bind:d,decorate:j,create:Object.create||g,subclass:l,mro:m,numericVersion:e,monkeyPatch:h,patch:function(){if(!Object.create)Object.create=g;h(Function,"org.startpad.funcs",i.VERSION,{methods:function(a){b(this,a)},curry:function(){var a=[this,void 0].concat(c.copyArray(arguments));return d.apply(void 0,a)},curryThis:function(a){var b=c.copyArray(arguments);
b.unshift(this);return d.apply(void 0,b)},decorate:function(a){return j(this,a)},subclass:function(a,c){l(this,a,c)},mro:function(a,c){a.unshift(this);m(a,c)}});return i}})});
namespace.module("org.startpad.string",function(i,f){function e(d,e,f){f=f||b;if(d==void 0)return"undefined";d=d.toString();return d=d.replace(f,function(b,d){for(var c=e,a=d.split("."),k=0;k<a.length;k++){var d=a[k],f=parseInt(d),c=isNaN(f)?c[d]:c[f];if(c==void 0)return""}return c})}var h=f("org.startpad.funcs");i.extend({VERSION:"0.3.0",patch:function(){h.monkeyPatch(String,"org.startpad.string",i.VERSION,{format:function(){return arguments.length==1&&typeof arguments[0]=="object"?e(this,arguments[0]):
e(this,arguments)}});return i},format:e,strip:function(b){return(b||"").replace(/^\s+|\s+$/g,"")}});var b=/\{\s*([^} ]+)\s*\}/g});namespace.module("com.pageforest.editor.codemirror",function(i){var f;i.extend({isProbablySupported:function(){return CodeMirror.isProbablySupported()&&!navigator.userAgent.match(/^Mozilla.5.0 .iPad/)},createEditor:function(e,h){var b={path:"/codemirror/js/",width:"100%",height:"100px",content:h},d=e.toLowerCase();d.substr(-5)==".html"?(b.stylesheet=["/codemirror/css/xmlcolors.css","/codemirror/css/jscolors.css","/codemirror/css/csscolors.css"],b.parserfile=["parsexml.js","parsecss.js","tokenizejavascript.js",
"parsejavascript.js","parsehtmlmixed.js"],b.parser="HTMLMixedParser"):d.substr(-4)==".xml"?(b.stylesheet="/codemirror/css/xmlcolors.css",b.parserfile=["parsexml.js"],b.parser="XMLParser"):d.substr(-3)==".js"||d.substr(-5)==".json"?(b.stylesheet="/codemirror/css/jscolors.css",b.parserfile=["tokenizejavascript.js","parsejavascript.js"],b.parser="JSParser"):d.substr(-4)==".css"?(b.stylesheet="/codemirror/css/csscolors.css",b.parserfile="parsecss.js",b.parser="CSSParser"):(b.parserfile="parsedummy.js",
b.parser="DummyParser");d=$('<textarea id="code"></textarea>');$("#content").empty().append(d);f=window.CodeMirror.fromTextArea("code",b)},adjustHeight:function(){if(f&&f.editor){var e=f.editor.container.scrollHeight;$(".CodeMirror-wrapping").css("height",e+"px")}},getData:function(){return f.getCode()},codemirror:f})});namespace.module("com.pageforest.editor",function(i){function f(a){$("#status").text(a)}function e(a){f(a.status+" "+a.statusText)}function h(){var a=[];a.push('<a href="#">apps</a>');a.push('<span class="quiet">/</span>');if(c.app_id){a.push('<a href="#'+c.app_id+'">'+c.app_id+"</a>");a.push('<span class="quiet">/</span>');for(var b="#"+c.app_id+"/",d=c.filename.split("/"),e=0;d[e];e++){var f=d[e];b+=f;e<d.length-1&&(b+="/");a.push('<a href="'+b+'">'+f+"</a>");b.substr(-1)=="/"&&a.push('<span class="quiet">/</span>')}}$("#breadcrumbs").html(a.join("\n"))}
function b(){var a=c.filename;a.substr(-1)=="/"&&(a=a.substr(0,a.length-1));console.log("showFiles: "+c.listing+" "+a);var b=[],d=a;d.substr(-1)=="/"&&(d=d.substr(0,d.length-1));var e=d.length||-1,h=[],i;for(i in c.listing)if(c.listing.hasOwnProperty(i)&&(d==""||i.charAt(e)=="/"&&i.substr(0,d.length)==d)){var g=i.substr(e+1).split("/");g.length==1?h.push(g[0]):(g=g[0]+"/",h.indexOf(g)==-1&&h.push(g))}for(d=0;d<h.length;d++){e=h[d];i=c.app_id+"/"+(a?a+"/":"")+e;g=i;if(g.substr(-1)=="/")g='<img width="83" height="64" src="/icons/64/folder.png" alt="" />';
else if(g.substr(-4)==".png")g='<img height="64" src="/mirror/'+g+'" alt="" />';else{var j="txt",l=g.lastIndexOf(".");l>0&&(j=g.substr(l+1).toLowerCase(),j=="json"&&(j="js"));g='<img width="54" height="64" src="/icons/64/'+j+'.png" alt="" />'}b.push('<div class="icon">');b.push('<a href="#'+i+'">'+g+"</a><br />");b.push('<a href="#'+i+'">'+e+"</a>");b.push("</div>")}h="/mirror/"+c.app_id+"/post?path="+a;b.push('<div style="width:100%; height:10em; clear:both">');b.push('<iframe class="upload" src="'+
h+'" style="width:100%; height:100%; border:none"></iframe>');b.push("</div>");$("#content").html(b.join("\n"));f("Loaded directory: "+c.app_id+"/"+a)}function d(){c.app_id="";console.log("loadAppList");$.ajax({url:"/mirror?method=list",dataType:"json",success:function(a){c.appListing=a.items;if(!c.app_id){var a=[],b;for(b in c.appListing)if(c.appListing.hasOwnProperty(b)){var d=c.appListing[b].icon?'<img width="64" height="64" src="/mirror/'+b+"/"+c.appListing[b].icon+'" alt="" />':'<img width="83" height="64" src="/icons/64/folder.png" alt="" />';
a.push('<div class="icon">');a.push('<a href="#'+b+'">'+d+"</a><br />");a.push('<a href="#'+b+'">'+b+"</a>");a.push("</div>")}$("#content").html(a.join("\n"));f("Loaded app list")}},error:function(a,b,c){a.status==403?($("#content").empty(),$("#status").html('<span class="error">Please sign in to edit your apps.</span>')):e(a,b,c)}})}function j(a){c.app_id=a;$.ajax({url:"/mirror/"+c.app_id+"?method=list&depth=0",dataType:"json",error:e,success:function(a){c.listing=a.items;(!c.filename||c.filename.substr(-1)==
"/")&&b()}})}function g(a){c.filename=a;h();a==""||a.substr(-1)=="/"?b():$.ajax({url:"/mirror/"+c.app_id+"/"+c.filename,dataType:"text",error:e,success:function(a){c.editor.createEditor(c.filename,a);c.editor.adjustHeight("shrink");f("Loaded file: "+c.filename)}})}function l(){var a=$("iframe.upload")[0];a&&(a=a.contentWindow.document.body.innerHTML.replace(/<\/?[^>]+>\s*/gi,""),a.substr(0,1)=="{"&&JSON.parse(a).status==200&&j(c.app_id))}function m(){var a=window.location.hash;if(a==c.hash)c.editor.adjustHeight();
else{c.hash=a;var b=a.substr(1).split("/");console.log("parts: ["+b+"]");a=b.shift();b=b.join("/");console.log("app_id: ["+a+"]");a?a!=c.app_id?(j(a),b?g(b):c.filename=""):b!=c.filename&&g(b):d()}}var c={};i.extend({onReady:function(){var a=namespace.lookup("com.pageforest.client");c.client=new a.Client(c);c.client.saveInterval=0;c.client.state="clean";c.hash="###";var a=c,b;b=namespace.lookup("com.pageforest.editor.codemirror");b=b.isProbablySupported()?b:namespace.lookup("com.pageforest.editor.textarea");
a.editor=b;c.app_id="";c.filename="";setInterval(m,200);setInterval(l,1E3)},onSave:function(){$.ajax({type:"PUT",url:"/mirror/"+c.app_id+"/"+c.filename,data:c.editor.getData(),dataType:"text",success:function(a){f(a)},error:e})},onUserChange:function(a){a==void 0?($("#username").text("anonymous"),$("#signin").text("Sign in").attr("href","http://www.pageforest.com/sign-in/editor")):($("#username").text(a),$("#signin").text("Sign out").attr("href","http://www.pageforest.com/sign-out/editor"));c.app_id||
d()},onSignInOut:function(){c.client.username!=void 0?c.client.signOut():c.client.signIn()},appListing:c.appListing,listing:c.listing,app_id:c.app_id,filename:c.filename,editor:c.editor,hash:c.hash,client:c.client})});namespace.module("com.pageforest.editor.textarea",function(i){i.extend({createEditor:function(f,e){var h=$('<textarea id="code"></textarea>');$("#content").empty().append(h);h.val(e).focus()},adjustHeight:function(f){for(var e=$("#code"),h=e.attr("scrollHeight"),b=e.attr("offsetHeight");f&&b&&h==b;)e.css("height",b/2+"px"),h=e.attr("scrollHeight"),b=e.attr("offsetHeight");h>b&&e.css("height",h+"px")},getData:function(){return $("textarea").val()}})});