(function(g){function c(){}function e(a){if(!a)return 0;a=a.split(".");return 1E4*parseInt(a[0])+100*parseInt(a[1])+parseInt(a[2])}function b(d){for(var d=d.replace(/-/g,"_"),d=d.split("."),b=a,f=0;f<d.length;f++)b[d[f]]===void 0&&(b[d[f]]=new c),b=b[d[f]];return b}var a=g.namespace;if(a){if(e("3.0.1")<=e(a.VERSION))return;c=a.constructor}else g.namespace=a=new c;a.VERSION="3.0.1";g=c.prototype;g.module=function(a,e){var f=b(a);e&&e(f,b);return f};g.extend=function(a){for(var b in a)a.hasOwnProperty(b)&&
(this[b]=a[b])}})(this);
namespace.module("org.startpad.types",function(g){function c(a,b){return e(a)==b}function e(f){if(f===void 0)return"undefined";if(f===null)return"null";var b=Object.prototype.toString.call(f).match(/\[object (.*)\]/)[1].toLowerCase();a.indexOf(b)==-1&&(b=typeof f);return b}function b(a){var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(d);return b}g.extend({VERSION:"0.2.2",isArguments:function(a){return c(a,"arguments")},isArray:function(a){return c(a,"array")},copyArray:function(a){return Array.prototype.slice.call(a)},isType:c,
typeOf:e,extend:function(a){var b,e,c,j;a===void 0&&(a={});for(b=1;b<arguments.length;b++){c=arguments[b];for(j in c)c.hasOwnProperty(j)&&(a[j]=c[j]);if(d)for(e=0;e<h.length;e++)j=h[e],c.hasOwnProperty(j)&&(a[j]=c[j])}return a},project:function(a,b){var d={};typeof b=="string"&&(b=[b]);for(var e=0;e<b.length;e++){var j=b[e];a&&a.hasOwnProperty(j)&&(d[j]=a[j])}return d},getFunctionName:function(a){if(typeof a=="function")return a=a.toString().match(/function\s*(\S+)\s*\(/),!a?"":a[1]},keys:Object.keys||
b,patch:function(){Object.keys=Object.keys||b;return g}});var a="number,string,boolean,array,function,date,regexp,arguments,undefined,null".split(","),d=!{toString:!0}.propertyIsEnumerable("toString"),h=["toString","toLocaleString","valueOf","constructor","isPrototypeOf"]});
namespace.module("org.startpad.funcs",function(g,c){function e(a){if(!a)return 0;a=a.split(".");return 1E4*parseInt(a[0])+100*parseInt(a[1])+parseInt(a[2])}function b(b,d,c,f){if(!(b._patches&&e(b._patches[d])>=e(c)))b._patches=b._patches||{},b._patches[d]=c,a(b,f)}function a(a,b){l.extend(a.prototype,b)}function d(a,b){function d(a,b){for(var i=l.copyArray(a),b=l.copyArray(b),e=0;e<i.length;e++)i[e]===void 0&&(i[e]=b.shift());return i.concat(b)}var e;e=arguments.length==3&&l.isArguments(arguments[2])?
Array.prototype.slice.call(arguments[2],self1):Array.prototype.slice.call(arguments,2);return function(){return a.apply(b||this,d(e,arguments))}}function h(a,b){function e(){return b.call(this,a,arguments,e)}b.call(a,void 0,arguments,e);return e}function f(a){function b(){}b.prototype=a;return new b}function m(b,e,d){b.prototype=g.create(e.prototype);b.prototype.constructor=b;a(b,d);return b}function n(b,e){for(var d=b.pop().prototype,c;b.length>0;){c=b.pop();var f=l.getFunctionName(c),h=g.create(d);
l.extend(h,c.prototype);h.constructor=c;h[f+"_super"]=d;d=h}c.prototype=d;a(c,e)}var l=c("org.startpad.types");g.extend({VERSION:"0.3.1",methods:a,bind:d,decorate:h,create:Object.create||f,subclass:m,mro:n,numericVersion:e,monkeyPatch:b,patch:function(){if(!Object.create)Object.create=f;b(Function,"org.startpad.funcs",g.VERSION,{methods:function(b){a(this,b)},curry:function(){var a=[this,void 0].concat(l.copyArray(arguments));return d.apply(void 0,a)},curryThis:function(a){var b=l.copyArray(arguments);
b.unshift(this);return d.apply(void 0,b)},decorate:function(a){return h(this,a)},subclass:function(a,b){m(this,a,b)},mro:function(a,b){a.unshift(this);n(a,b)}});return g}})});
namespace.module("org.startpad.string",function(g,c){function e(b,e,c){c=c||a;if(b==void 0)return"undefined";b=b.toString();return b=b.replace(c,function(a,b){for(var c=e,d=b.split("."),f=0;f<d.length;f++){var b=d[f],g=parseInt(b),c=isNaN(g)?c[b]:c[g];if(c==void 0)return""}return c})}var b=c("org.startpad.funcs");g.extend({VERSION:"0.3.0",patch:function(){b.monkeyPatch(String,"org.startpad.string",g.VERSION,{format:function(){return arguments.length==1&&typeof arguments[0]=="object"?e(this,arguments[0]):
e(this,arguments)}});return g},format:e,strip:function(b){return(b||"").replace(/^\s+|\s+$/g,"")}});var a=/\{\s*([^} ]+)\s*\}/g});namespace.module("com.pageforest.editor.codemirror",function(g){var c;g.extend({isProbablySupported:function(){return CodeMirror.isProbablySupported()&&!navigator.userAgent.match(/^Mozilla.5.0 .iPad/)},createEditor:function(e,b){var a={path:"/codemirror/js/",width:"100%",height:"100px",content:b},d=e.toLowerCase();d.substr(-5)==".html"?(a.stylesheet=["/codemirror/css/xmlcolors.css","/codemirror/css/jscolors.css","/codemirror/css/csscolors.css"],a.parserfile=["parsexml.js","parsecss.js","tokenizejavascript.js",
"parsejavascript.js","parsehtmlmixed.js"],a.parser="HTMLMixedParser"):d.substr(-4)==".xml"?(a.stylesheet="/codemirror/css/xmlcolors.css",a.parserfile=["parsexml.js"],a.parser="XMLParser"):d.substr(-3)==".js"||d.substr(-5)==".json"?(a.stylesheet="/codemirror/css/jscolors.css",a.parserfile=["tokenizejavascript.js","parsejavascript.js"],a.parser="JSParser"):d.substr(-4)==".css"?(a.stylesheet="/codemirror/css/csscolors.css",a.parserfile="parsecss.js",a.parser="CSSParser"):(a.parserfile="parsedummy.js",
a.parser="DummyParser");d=$('<textarea id="code"></textarea>');$("#content").empty().append(d);c=window.CodeMirror.fromTextArea("code",a)},adjustHeight:function(){if(c&&c.editor){var e=c.editor.container.scrollHeight;$(".CodeMirror-wrapping").css("height",e+"px")}},getData:function(){return c.getCode()},codemirror:c})});namespace.module("com.pageforest.editor",function(g){var c,e,b,a,d,h,f;function m(b){$("#status").text(b)}function n(b){m(b.status+" "+b.statusText)}function l(){var i=[];i.push('<a href="#">apps</a>');i.push('<span class="quiet">/</span>');if(b){i.push('<a href="#'+b+'">'+b+"</a>");i.push('<span class="quiet">/</span>');for(var e="#"+b+"/",c=a.split("/"),d=0;c[d];d++){var f=c[d];e+=f;d<c.length-1&&(e+="/");i.push('<a href="'+e+'">'+f+"</a>");e.substr(-1)=="/"&&i.push('<span class="quiet">/</span>')}}$("#breadcrumbs").html(i.join("\n"))}
function j(){var i=a;i.substr(-1)=="/"&&(i=i.substr(0,i.length-1));console.log("showFiles: "+e+" "+i);var c=[],d=i;d.substr(-1)=="/"&&(d=d.substr(0,d.length-1));var f=d.length||-1,g=[],h;for(h in e)if(e.hasOwnProperty(h)&&(d==""||h.charAt(f)=="/"&&h.substr(0,d.length)==d)){var k=h.substr(f+1).split("/");k.length==1?g.push(k[0]):(k=k[0]+"/",g.indexOf(k)==-1&&g.push(k))}for(d=0;d<g.length;d++){f=g[d];h=b+"/"+(i?i+"/":"")+f;k=h;if(k.substr(-1)=="/")k='<img width="83" height="64" src="/icons/64/folder.png" alt="" />';
else if(k.substr(-4)==".png")k='<img height="64" src="/mirror/'+k+'" alt="" />';else{var j="txt",l=k.lastIndexOf(".");l>0&&(j=k.substr(l+1).toLowerCase(),j=="json"&&(j="js"));k='<img width="54" height="64" src="/icons/64/'+j+'.png" alt="" />'}c.push('<div class="icon">');c.push('<a href="#'+h+'">'+k+"</a><br />");c.push('<a href="#'+h+'">'+f+"</a>");c.push("</div>")}g="/mirror/"+b+"/post?path="+i;c.push('<div style="width:100%; height:10em; clear:both">');c.push('<iframe class="upload" src="'+g+'" style="width:100%; height:100%; border:none"></iframe>');
c.push("</div>");$("#content").html(c.join("\n"));m("Loaded directory: "+b+"/"+i)}function o(){b="";console.log("loadAppList");$.ajax({url:"/mirror?method=list",dataType:"json",success:function(a){c=a.items;if(!b){var a=[],d;for(d in c)if(c.hasOwnProperty(d)){var e=c[d].icon?'<img width="64" height="64" src="/mirror/'+d+"/"+c[d].icon+'" alt="" />':'<img width="83" height="64" src="/icons/64/folder.png" alt="" />';a.push('<div class="icon">');a.push('<a href="#'+d+'">'+e+"</a><br />");a.push('<a href="#'+
d+'">'+d+"</a>");a.push("</div>")}$("#content").html(a.join("\n"));m("Loaded app list")}},error:function(a,b,d){a.status==403?($("#content").empty(),$("#status").html('<span class="error">Please sign in to edit your apps.</span>')):n(a,b,d)}})}function p(d){b=d;$.ajax({url:"/mirror/"+b+"?method=list&depth=0",dataType:"json",error:n,success:function(b){e=b.items;(!a||a.substr(-1)=="/")&&j()}})}function q(c){a=c;l();c==""||c.substr(-1)=="/"?j():$.ajax({url:"/mirror/"+b+"/"+a,dataType:"text",error:n,
success:function(b){d.createEditor(a,b);d.adjustHeight("shrink");m("Loaded file: "+a)}})}function r(){var a=$("iframe.upload")[0];a&&(a=a.contentWindow.document.body.innerHTML.replace(/<\/?[^>]+>\s*/gi,""),a.substr(0,1)=="{"&&JSON.parse(a).status==200&&p(b))}function s(){var c=window.location.hash;if(c==h)d.adjustHeight();else{h=c;var e=c.substr(1).split("/");console.log("parts: ["+e+"]");c=e.shift();e=e.join("/");console.log("app_id: ["+c+"]");c?c!=b?(p(c),e?q(e):a=""):e!=a&&q(e):o()}}c=void 0;e=
void 0;b=void 0;a=void 0;d=void 0;h=void 0;f=void 0;g.extend({onReady:function(){f=new (namespace.lookup("com.pageforest.client").Client)(g);f.saveInterval=0;f.state="clean";h="###";var c=namespace.lookup("com.pageforest.editor.codemirror");d=c.isProbablySupported()?c:namespace.lookup("com.pageforest.editor.textarea");a=b="";setInterval(s,200);setInterval(r,1E3)},onSave:function(){$.ajax({type:"PUT",url:"/mirror/"+b+"/"+a,data:d.getData(),dataType:"text",success:function(a){m(a)},error:n})},onUserChange:function(a){console.log("onUserChange("+
a+");");a==void 0?($("#username").text("anonymous"),$("#signin").text("Sign in").attr("href","http://www.pageforest.com/sign-in/editor")):($("#username").text(a),$("#signin").text("Sign out").attr("href","http://www.pageforest.com/sign-out/editor"));b||o()},onSignInOut:function(){f.username!=void 0?f.signOut():f.signIn()},appListing:c,listing:e,app_id:b,filename:a,editor:d,hash:h,client:f})});namespace.module("com.pageforest.editor.textarea",function(g){g.extend({createEditor:function(c,e){var b=$('<textarea id="code"></textarea>');$("#content").empty().append(b);b.val(e).focus()},adjustHeight:function(c){for(var e=$("#code"),b=e.attr("scrollHeight"),a=e.attr("offsetHeight");c&&a&&b==a;)e.css("height",a/2+"px"),b=e.attr("scrollHeight"),a=e.attr("offsetHeight");b>a&&e.css("height",b+"px")},getData:function(){return $("textarea").val()}})});